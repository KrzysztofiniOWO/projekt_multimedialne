{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Your Webpage</title>
    <link rel="stylesheet" href="{% static '../static/style.css' %}">
</head>
<body>
    <header>
    </header>
    <div>
        <p id="log"></p>
    </div>
    <div class="centered-buttons">
        <!-- Przycisk do wyświetlania powiadomień -->
        <button class="green-button" onclick="showNotifications()">Pokaż powiadomienia</button>
        
        <!-- Lista, w której będą przechowywane powiadomienia -->
        <ul id="notification-list" style="display: none;"></ul>
        
        <!-- Pozostałe przyciski -->
        <a href="{% url 'kelner_menu' %}"><button class="green-button">Wyświetl menu</button></a>
        <a href="{% url 'kelner_map' %}"><button class="green-button">Wyświetl mapę lokalu</button></a>
        <a href="{% url 'kelner_add_order' %}"><button class="green-button">Wprowadź zamówienie</button></a>
        <a href="{% url 'kelner_receipt' %}"><button class="green-button">Wyślij rachunek</button></a>
    </div>
    <script>
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const notificationSocket = new WebSocket(
            wsScheme + '://' + window.location.host + '/ws/notification/'
        );
            
        notificationSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            createNotificationBubble(data.message);
            playNotificationSound(); // Odtwarzanie dzwięku zaraz po odebraniu powiadomienia
        };
        
        const activeBubbles = [];
        const notificationList = document.getElementById('notification-list');

        function showNotifications() {
            // Funkcja do wyświetlania powiadomień z listy
            notificationList.style.display = 'block';
        }

        function clearNotifications() {
            // Funkcja do usuwania wszystkich powiadomień z listy
            while (notificationList.firstChild) {
                notificationList.removeChild(notificationList.firstChild);
            }
        }

        function addNotificationToList(message) {
            // Funkcja do dodawania nowego powiadomienia do listy
            const li = document.createElement('li');
            li.textContent = message;
            
            // Dodanie przycisku do usuwania powiadomienia
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Usuń';
            deleteButton.onclick = function () {
                li.remove();
                updateBubblePositions(); // Aktualizacja pozycji po usunięciu powiadomienia
            };

            li.appendChild(deleteButton);
            notificationList.appendChild(li);
        }

        function createNotificationBubble(message) {
            const bubble = document.createElement('div');
            bubble.className = 'notification-bubble';
            bubble.innerText = message;
            document.body.appendChild(bubble);
            
            // Dodanie powiadomienia do listy
            addNotificationToList(message);
            
            // Dodanie dymka do listy i aktualizacja pozycji
            activeBubbles.push(bubble);
            updateBubblePositions();

            // Usunięcie dymka po zakończeniu animacji i aktualizacja pozycji pozostałych
            bubble.addEventListener('animationend', () => {
                bubble.remove();
                const index = activeBubbles.indexOf(bubble);
                activeBubbles.splice(index, 1);
                updateBubblePositions();
            });
        }

        function playNotificationSound() {
            const audio = new Audio('/static/rura.mp3'); // Ścieżka do pliku dźwiękowego
            audio.play();
        }
        
        function updateBubblePositions() {
            let offset = 10; // Początkowy offset dla pierwszego dymka
            activeBubbles.forEach(bubble => {
                bubble.style.top = `${offset}px`; // Ustawienie pozycji dymka
                offset += bubble.offsetHeight + 10; // Aktualizacja offsetu dla następnego dymka
            });
        }
    </script>        
</body>
</html>
